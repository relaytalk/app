<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>RelayTalk - Connect with Friends Instantly</title>

    <!-- Basic SEO -->
    <meta name="description" content="RelayTalk - Connect with friends instantly. Secure, private messaging platform.">
    <meta name="keywords" content="RelayTalk, messaging, chat, friends, secure messaging">
    <meta name="robots" content="index, follow">

    <!-- Canonical - ROOT PAGE -->
    <link rel="canonical" href="https://relaytalk.vercel.app/">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="RelayTalk">
    <meta property="og:title" content="RelayTalk - Connect with Friends Instantly">
    <meta property="og:description" content="RelayTalk - Connect with friends instantly. Secure, private messaging.">
    <meta property="og:url" content="https://relaytalk.vercel.app/">
    <meta property="og:image" content="https://relaytalk.vercel.app/relayad.png">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@RelayTalk">
    <meta name="twitter:title" content="RelayTalk - Connect with Friends Instantly">
    <meta name="twitter:description" content="RelayTalk - Connect with friends instantly. Secure, private messaging.">
    <meta name="twitter:image" content="https://relaytalk.vercel.app/relayad.png">

    <!-- Favicon / Icons -->
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/relay.png" type="image/png" sizes="192x192">
    <link rel="apple-touch-icon" href="/relay.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#007ACC">

    <!-- ‚úÖ FIXED: ONLY redirect if LOGGED IN - using more reliable check -->
    <script>
        (function() {
            try {
                // Check for Supabase session token
                let hasSession = false;
                
                // Check localStorage
                const localToken = localStorage.getItem('supabase.auth.token');
                // Check sessionStorage
                const sessionToken = sessionStorage.getItem('supabase.auth.token');
                
                hasSession = !!(localToken || sessionToken);
                
                // Additional check: if we have persisted session in localStorage
                if (!hasSession) {
                    try {
                        const persistedSession = localStorage.getItem('supabase.auth.token');
                        if (persistedSession && persistedSession.includes('access_token')) {
                            hasSession = true;
                        }
                    } catch (e) {}
                }

                // ‚úÖ ONLY redirect if LOGGED IN
                if (hasSession) {
                    console.log('‚úÖ User has session - redirecting to home');
                    window.location.replace('/pages/home/index.html?v=' + Date.now());
                }
                // ‚ùå NEVER redirect if not logged in - stay on root page
            } catch (e) {
                console.log('Session check error:', e);
            }
        })();
    </script>

    <!-- Stylesheets -->
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="/opening.css">
</head>
<body>
    <!-- Opening Animation -->
    <div class="opening-screen" id="openingScreen">
        <div class="luster-text">‚ú®Relay</div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div class="welcome-container">
            <div class="logo">‚ú®</div>
            <h1 class="title">RelayTalk</h1>
            <p class="subtitle">Connect with friends instantly</p>

            <div class="features">
                <div class="feature-card">
                    <div class="feature-icon">üîç</div>
                    <h3>Search Friends</h3>
                    <p>Find and connect with friends</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üîî</div>
                    <h3>Notifications</h3>
                    <p>Stay updated with messages</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üí¨</div>
                    <h3>Instant Chat</h3>
                    <p>Real-time messaging</p>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn-primary" onclick="goToSignup()">Create Account</button>
                <button class="btn-secondary" onclick="goToLogin()">Login</button>
            </div>
        </div>
    </div>

    <script>
        window.goToLogin = function() { 
            window.location.href = '/pages/login/index.html';
        };

        window.goToSignup = function() { 
            window.location.href = '/pages/auth/index.html';
        };

        // ‚úÖ FIXED: Only redirect if LOGGED IN - and wait for opening animation
        document.addEventListener('DOMContentLoaded', async function() {
            // Always show content first
            const openingScreen = document.getElementById('openingScreen');
            const mainContent = document.getElementById('mainContent');

            if (openingScreen) {
                openingScreen.style.opacity = '0';
                setTimeout(() => {
                    openingScreen.style.display = 'none';
                }, 400);
            }

            if (mainContent) {
                mainContent.style.opacity = '1';
            }

            // THEN check auth, but only redirect if logged in
            try {
                // Check if we have a session first to avoid unnecessary imports
                let hasSession = false;
                const localToken = localStorage.getItem('supabase.auth.token');
                const sessionToken = sessionStorage.getItem('supabase.auth.token');
                hasSession = !!(localToken || sessionToken);
                
                if (!hasSession) {
                    console.log('No session detected - staying on main page');
                    return; // ‚úÖ CRITICAL: DON'T redirect if no session
                }
                
                // Only try to import if we have a session
                try {
                    const module = await import('/utils/auth.js');
                    const { success } = await module.auth.getCurrentUser();

                    // ‚úÖ ONLY redirect if actually logged in
                    if (success) {
                        console.log('‚úÖ User authenticated - redirecting to home');
                        window.location.replace('/pages/home/index.html');
                    }
                    // ‚ùå NEVER redirect if not logged in - stay on root page
                } catch (e) {
                    console.log('Auth import error:', e);
                    // Even if import fails, if we have session, try to redirect anyway
                    if (hasSession) {
                        window.location.replace('/pages/home/index.html');
                    }
                }
            } catch (e) {
                console.log('Auth check error:', e);
            }
        });
    </script>

    <script src="/utils/sw-manager.js"></script>
</body>
</html>