<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call</title>
    <style>
        body { margin: 0; padding: 20px; background: #1a1a1a; color: white; font-family: Arial; }
        #status { padding: 20px; background: #333; margin: 10px; border-radius: 8px; }
        #roomInfo { padding: 20px; background: #2a2a2a; margin: 10px; border-radius: 8px; word-break: break-all; }
        button { padding: 15px 30px; margin: 10px; background: #007acc; color: white; border: none; border-radius: 8px; cursor: pointer; }
        #dailyFrame { width: 100%; height: 500px; background: #000; margin: 10px; border-radius: 8px; display: none; }
        .debug-box { background: #333; padding: 10px; margin: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <!-- STEP 1: CATCH ALL REDIRECTS -->
    <script>
        (function() {
            console.log('üö® REDIRECT CATCHER ACTIVE');
            
            // Store original functions
            const originalReplace = window.location.replace;
            const originalAssign = window.location.assign;
            
            // Override them
            window.location.replace = function(url) {
                console.error('üî¥ REDIRECT ATTEMPTED (replace):', url);
                console.trace('Stack trace:');
                document.body.innerHTML += `<div style="background:#ff0000; color:white; padding:10px; margin:10px;">
                    <strong>üö´ REDIRECT BLOCKED TO:</strong> ${url}<br>
                    <small>Check console for stack trace</small>
                </div>`;
                return false;
            };
            
            window.location.assign = function(url) {
                console.error('üî¥ REDIRECT ATTEMPTED (assign):', url);
                console.trace('Stack trace:');
                document.body.innerHTML += `<div style="background:#ff0000; color:white; padding:10px; margin:10px;">
                    <strong>üö´ REDIRECT BLOCKED TO:</strong> ${url}<br>
                    <small>Check console for stack trace</small>
                </div>`;
                return false;
            };
            
            console.log('‚úÖ Redirect catcher ready');
        })();
    </script>

    <h1>üìû Call Page - Debug Mode</h1>
    
    <div class="debug-box" id="debugInfo">
        Loading debug info...
    </div>
    
    <div id="status">üîç Initializing...</div>
    <div id="roomInfo">Waiting for room URL...</div>
    <div id="dailyFrame"></div>

    <div style="display: flex; justify-content: center;">
        <button onclick="goBack()">‚Üê Back to Friends</button>
    </div>

    <script>
        // STEP 2: Log everything
        console.log('üöÄ PAGE STARTED');
        console.log('üìç URL:', window.location.href);
        console.log('üìç Params:', window.location.search);
        console.log('üìç Path:', window.location.pathname);
        
        // Check localStorage
        console.log('üìç localStorage keys:', Object.keys(localStorage));
        console.log('üìç Has supabase token:', !!localStorage.getItem('supabase.auth.token'));
        
        // Update debug box
        document.getElementById('debugInfo').innerHTML = `
            <strong>URL:</strong> ${window.location.href}<br>
            <strong>Room param:</strong> ${new URLSearchParams(window.location.search).get('room') || 'MISSING'}<br>
            <strong>Has session:</strong> ${!!localStorage.getItem('supabase.auth.token')}<br>
            <strong>Time:</strong> ${new Date().toLocaleTimeString()}
        `;

        // STEP 3: Get room URL
        const urlParams = new URLSearchParams(window.location.search);
        let roomUrl = urlParams.get('room');

        const roomInfo = document.getElementById('roomInfo');
        const statusDiv = document.getElementById('status');

        roomInfo.innerHTML = `
            <strong>Room URL:</strong> ${roomUrl || '‚ùå NOT FOUND!'}<br>
            <strong>Full URL:</strong> ${window.location.href}<br>
            <strong>Time:</strong> ${new Date().toLocaleTimeString()}
        `;

        if (!roomUrl) {
            statusDiv.innerHTML = '‚ùå ERROR: No room URL!';
            throw new Error('No room URL');
        }

        statusDiv.innerHTML = '‚úÖ Room URL found! Loading Daily.co...';

        // STEP 4: Load Daily.co
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/@daily-co/daily-js';
        script.onload = function() {
            statusDiv.innerHTML = '‚úÖ Daily.co loaded! Creating call...';
            startCall();
        };
        script.onerror = function() {
            statusDiv.innerHTML = '‚ùå Failed to load Daily.co';
        };
        document.head.appendChild(script);

        function startCall() {
            try {
                statusDiv.innerHTML = 'üîß Creating call frame...';

                // Hide status, show video
                document.getElementById('status').style.display = 'none';
                document.getElementById('roomInfo').style.display = 'none';
                document.getElementById('dailyFrame').style.display = 'block';

                // Get user name from localStorage
                let userName = 'User';
                try {
                    const sessionStr = localStorage.getItem('supabase.auth.token');
                    if (sessionStr) {
                        const session = JSON.parse(sessionStr);
                        const user = session?.user || session?.currentSession?.user;
                        if (user?.email) {
                            userName = user.email.split('@')[0];
                        }
                    }
                } catch(e) {
                    console.log('Could not get user name:', e);
                }

                // Create call
                const callFrame = window.DailyIframe.createFrame(
                    document.getElementById('dailyFrame'),
                    {
                        showLeaveButton: true,
                        iframeStyle: {
                            width: '100%',
                            height: '100%',
                            border: '0'
                        }
                    }
                );

                statusDiv.style.display = 'block';
                statusDiv.innerHTML = 'üîå Joining call...';

                callFrame.join({
                    url: roomUrl,
                    userName: userName
                });

                callFrame.on('joined-meeting', () => {
                    statusDiv.style.display = 'none';
                });

                callFrame.on('left-meeting', () => {
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = 'üëã Call ended';
                    document.getElementById('roomInfo').style.display = 'block';
                    document.getElementById('roomInfo').innerHTML = 'Call ended. Click Back to return.';
                });

            } catch (error) {
                statusDiv.innerHTML = '‚ùå Error: ' + error.message;
            }
        }

        window.goBack = function() {
            console.log('üîô Going back to friends');
            window.location.href = '/pages/home/friends/index.html';
        };

        // Keep alive log
        setInterval(() => {
            console.log('‚è±Ô∏è Still on call page -', new Date().toLocaleTimeString());
        }, 2000);
    </script>
</body>
</html>