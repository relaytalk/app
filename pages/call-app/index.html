<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CallApp Â· Voice Calls</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-indicator" id="loadingIndicator">
        <div class="loading-spinner"></div>
        <div id="loadingText">Accessing CallApp...</div>
    </div>

    <!-- Header -->
    <header class="app-header">
        <div class="header-content">
            <h1 class="header-title">ðŸ“ž CallApp</h1>
            <div class="header-actions">
                <button class="header-btn" onclick="window.location.href='/'">
                    <i class="fas fa-arrow-left"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="mainContent"></main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav" id="bottomNav" style="display: none;">
        <a href="#" class="nav-item active" onclick="loadDashboard()">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="#" class="nav-item" onclick="loadFriends()">
            <i class="fas fa-users"></i>
            <span>Friends</span>
        </a>
        <a href="pages/history/index.html" class="nav-item">
            <i class="fas fa-history"></i>
            <span>History</span>
        </a>
        <a href="profile.html" class="nav-item">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </a>
    </nav>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <script type="module">
        import { initializeSupabase } from './utils/supabase.js'
        import { 
            getRelayTalkUser, 
            syncUserToDatabase, 
            syncFriendsFromRelayTalk,
            getUserFriends,
            updateUserStatus 
        } from './utils/userSync.js'
        import { initCallListener } from './utils/callListener.js'
        
        let supabase
        let currentUser
        let friends = []
        
        async function init() {
            showLoading(true, 'Accessing CallApp...')
            
            try {
                const user = getRelayTalkUser()
                if (!user) {
                    showError('Please login to RelayTalk first')
                    return
                }
                
                console.log('âœ… Got user from RelayTalk:', user.email)
                
                supabase = await initializeSupabase()
                currentUser = await syncUserToDatabase(supabase, user)
                
                // Sync friends from old app
                await syncFriendsFromRelayTalk(supabase, currentUser.id)
                
                // Load friends list
                friends = await getUserFriends(supabase, currentUser.id)
                
                initCallListener(supabase, currentUser, showIncomingCall)
                
                showLoading(false)
                document.getElementById('bottomNav').style.display = 'flex'
                loadDashboard()
                
                // Update status periodically
                setInterval(() => {
                    updateUserStatus(supabase, currentUser.id, 'online')
                }, 30000)
                
            } catch (error) {
                console.error('Init error:', error)
                showError('Failed to initialize: ' + error.message)
            }
        }
        
        // Show incoming call (used by listener)
        window.showIncomingCall = function(call, caller) {
            showIncomingCallNotification(call, caller)
        }
        
        function showIncomingCallNotification(call, caller) {
            const notification = document.createElement('div')
            notification.id = 'incomingCallNotification'
            notification.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: #f5b342;
                color: #333;
                padding: 16px 20px;
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: space-between;
                animation: slideDown 0.3s ease;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            `
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="width: 44px; height: 44px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #f5b342; font-size: 20px; font-weight: bold;">
                        ${caller?.avatar_url 
                            ? `<img src="${caller.avatar_url}" style="width:44px; height:44px; border-radius:50%; object-fit:cover;">`
                            : (caller?.username?.charAt(0).toUpperCase() || '?')
                        }
                    </div>
                    <div>
                        <div style="font-weight: bold;">${caller?.username || 'Incoming Call'}</div>
                        <div style="font-size: 13px;">ðŸ”Š Incoming voice call...</div>
                    </div>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button onclick="acceptCall('${call.id}', '${call.room_name}', '${call.caller_id}')" style="background: white; border: none; color: #28a745; width: 44px; height: 44px; border-radius: 50%; font-size: 20px; cursor: pointer;">
                        <i class="fas fa-phone-alt"></i>
                    </button>
                    <button onclick="declineCall('${call.id}')" style="background: white; border: none; color: #dc3545; width: 44px; height: 44px; border-radius: 50%; font-size: 20px; cursor: pointer;">
                        <i class="fas fa-phone-slash"></i>
                    </button>
                </div>
            `
            
            document.body.prepend(notification)
        }
        
        window.acceptCall = function(callId, roomName, callerId) {
            document.getElementById('incomingCallNotification')?.remove()
            window.location.href = `pages/call/index.html?incoming=true&room=${roomName}&callerId=${callerId}&callId=${callId}`
        }
        
        window.declineCall = async function(callId) {
            document.getElementById('incomingCallNotification')?.remove()
            await supabase
                .from('calls')
                .update({ status: 'rejected', ended_at: new Date().toISOString() })
                .eq('id', callId)
        }
        
        window.loadDashboard = function() {
            updateActiveNav('home')
            
            const onlineFriends = friends.filter(f => f.status === 'online').length
            
            document.getElementById('mainContent').innerHTML = `
                <div class="dashboard-container">
                    <div class="welcome-card" style="background: #fff9e6; border-color: #f5b342;">
                        <div class="welcome-avatar" style="background: #f5b342;">
                            ${currentUser.avatar_url 
                                ? `<img src="${currentUser.avatar_url}" alt="${currentUser.username}">`
                                : `<span>${currentUser.username.charAt(0).toUpperCase()}</span>`
                            }
                        </div>
                        <div class="welcome-info">
                            <h2>Welcome back, ${currentUser.username}!</h2>
                            <p style="color: #666;">${friends.length} friends Â· ${onlineFriends} online</p>
                        </div>
                    </div>
                    
                    <div class="quick-actions">
                        <div class="action-card" onclick="loadFriends()" style="border-color: #f5b342;">
                            <div class="action-icon" style="background: #f5b342;">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="action-info">
                                <h3>Friends</h3>
                                <p>Call your friends instantly</p>
                            </div>
                        </div>
                        
                        <div class="action-card" onclick="window.location.href='pages/history/index.html'" style="border-color: #f5b342;">
                            <div class="action-icon" style="background: #f5b342;">
                                <i class="fas fa-history"></i>
                            </div>
                            <div class="action-info">
                                <h3>Call History</h3>
                                <p>View your past calls</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="recent-section" style="border-color: #f5b342;">
                        <h3>Quick Call</h3>
                        <div class="recent-list" id="quickCallList">
                            ${renderQuickCallList()}
                        </div>
                    </div>
                </div>
            `
        }
        
        function renderQuickCallList() {
            if (!friends || friends.length === 0) {
                return `
                    <div class="empty-small">
                        <p>No friends yet</p>
                        <button onclick="loadFriends()" class="link-btn" style="color: #f5b342;">Add friends</button>
                    </div>
                `
            }
            
            const onlineFriends = friends.filter(f => f.status === 'online').slice(0, 3)
            
            if (onlineFriends.length === 0) {
                return `
                    <div class="empty-small">
                        <p>No friends online</p>
                    </div>
                `
            }
            
            let html = ''
            onlineFriends.forEach(friend => {
                html += `
                    <div class="recent-friend-item">
                        <div class="friend-avatar small" style="background: #f5b342;">
                            ${friend.avatar_url 
                                ? `<img src="${friend.avatar_url}" alt="${friend.username}">`
                                : `<span>${friend.username.charAt(0).toUpperCase()}</span>`
                            }
                            <span class="status-dot online"></span>
                        </div>
                        <div class="friend-info">
                            <div class="friend-name">${friend.username}</div>
                            <div class="friend-status">Online</div>
                        </div>
                        <button class="call-btn small" style="background: #f5b342;" onclick="startCall('${friend.id}', '${friend.username}')">
                            <i class="fas fa-phone"></i>
                        </button>
                    </div>
                `
            })
            
            return html
        }
        
        window.loadFriends = async function() {
            updateActiveNav('friends')
            
            document.getElementById('mainContent').innerHTML = `
                <div class="friends-container">
                    <div class="search-box">
                        <i class="fas fa-search" style="color: #f5b342;"></i>
                        <input type="text" id="friendSearch" placeholder="Search friends..." oninput="searchFriends()" style="border-color: #f5b342; focus:border-color: #f5b342;">
                    </div>
                    <div id="friendsList" class="friends-list">
                        ${renderFriendsList(friends)}
                    </div>
                </div>
            `
        }
        
        function renderFriendsList(friendsToRender) {
            if (!friendsToRender || friendsToRender.length === 0) {
                return `
                    <div class="empty-state">
                        <i class="fas fa-users" style="color: #f5b342;"></i>
                        <h3>No friends yet</h3>
                        <p>Add friends from RelayTalk to see them here</p>
                        <button onclick="window.location.href='/'" class="primary-btn" style="background: #f5b342; color: #333;">
                            Go to RelayTalk
                        </button>
                    </div>
                `
            }
            
            let html = ''
            friendsToRender.forEach(friend => {
                const online = friend.status === 'online'
                const lastSeen = friend.last_seen ? formatLastSeen(friend.last_seen) : 'Offline'
                
                html += `
                    <div class="friend-item" style="border-color: #f5b342;">
                        <div class="friend-avatar" style="background: #f5b342;">
                            ${friend.avatar_url 
                                ? `<img src="${friend.avatar_url}" alt="${friend.username}">`
                                : `<span>${friend.username.charAt(0).toUpperCase()}</span>`
                            }
                            <span class="status-indicator ${online ? 'online' : 'offline'}"></span>
                        </div>
                        <div class="friend-info">
                            <div class="friend-name">${friend.username}</div>
                            <div class="friend-status-text">${online ? 'Online' : lastSeen}</div>
                        </div>
                        <button class="call-btn" style="background: #f5b342;" onclick="startCall('${friend.id}', '${friend.username}')">
                            <i class="fas fa-phone"></i>
                        </button>
                    </div>
                `
            })
            
            return html
        }
        
        window.searchFriends = function() {
            const term = document.getElementById('friendSearch').value.toLowerCase()
            
            if (!term) {
                document.getElementById('friendsList').innerHTML = renderFriendsList(friends)
                return
            }
            
            const filtered = friends.filter(f => 
                f.username.toLowerCase().includes(term)
            )
            
            document.getElementById('friendsList').innerHTML = renderFriendsList(filtered)
        }
        
        window.startCall = function(friendId, friendName) {
            window.location.href = `pages/call/index.html?friendId=${friendId}&friendName=${encodeURIComponent(friendName)}`
        }
        
        function formatLastSeen(timestamp) {
            const now = new Date()
            const time = new Date(timestamp)
            const diff = Math.floor((now - time) / 60000)
            
            if (diff < 1) return 'Just now'
            if (diff < 60) return `${diff}m ago`
            if (diff < 1440) return `${Math.floor(diff / 60)}h ago`
            return time.toLocaleDateString()
        }
        
        function updateActiveNav(active) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active')
            })
            if (active === 'home') document.querySelector('.nav-item:nth-child(1)').classList.add('active')
            if (active === 'friends') document.querySelector('.nav-item:nth-child(2)').classList.add('active')
        }
        
        function showLoading(show, text) {
            document.getElementById('loadingIndicator').style.display = show ? 'flex' : 'none'
            if (text) document.getElementById('loadingText').textContent = text
        }
        
        function showError(message) {
            showLoading(false)
            document.getElementById('mainContent').innerHTML = `
                <div class="error-container">
                    <i class="fas fa-exclamation-circle" style="color: #f5b342;"></i>
                    <h3>Access Denied</h3>
                    <p>${message}</p>
                    <a href="/" class="primary-btn" style="background: #f5b342; color: #333;">Go to RelayTalk</a>
                </div>
            `
        }
        
        // Start
        init()
    </script>
</body>
</html>